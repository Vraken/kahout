<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kahoot Clone â€“ HÃ´te</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #f8f9fb; color: #1a1a2e; min-height: 100vh; line-height: 1.5; }
  .screen { display: none; min-height: 100vh; flex-direction: column; }
  .screen.active { display: flex; }

  .tabs { display: flex; background: white; border-bottom: 1px solid #e5e7eb; }
  .tab { padding: 16px 28px; cursor: pointer; font-weight: 500; font-size: 0.9rem; border-bottom: 2px solid transparent; transition: all 0.2s; color: #6b7280; }
  .tab:hover { color: #1a1a2e; background: #f9fafb; }
  .tab.active { color: #4f46e5; border-bottom-color: #4f46e5; }

  /* â”€â”€ LIBRARY â”€â”€ */
  #library { background: #f8f9fb; }
  .lib-header { padding: 28px 32px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; background: white; border-bottom: 1px solid #e5e7eb; }
  .lib-header h1 { font-size: 1.35rem; font-weight: 700; color: #1a1a2e; }
  .quiz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 32px; }
  .quiz-card { background: white; border-radius: 16px; padding: 24px; transition: all 0.25s ease; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
  .quiz-card:hover { border-color: #d1d5db; box-shadow: 0 8px 24px rgba(0,0,0,0.08); transform: translateY(-2px); }
  .quiz-card h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: #1a1a2e; }
  .quiz-card .meta { font-size: 0.85rem; color: #6b7280; margin-bottom: 16px; }
  .quiz-card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
  .empty-lib { text-align: center; padding: 80px 20px; color: #9ca3af; }
  .empty-lib .icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }

  /* â”€â”€ EDITOR â”€â”€ */
  #editor { background: #f8f9fb; color: #1a1a2e; }
  .editor-header { background: white; color: #1a1a2e; padding: 16px 24px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap; border-bottom: 1px solid #e5e7eb; }
  .editor-header input[type=text] { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; color: #1a1a2e; padding: 10px 16px; font-size: 0.95rem; font-weight: 600; width: 280px; max-width: 100%; transition: all 0.2s; }
  .editor-header input[type=text]::placeholder { color: #9ca3af; }
  .editor-header input[type=text]:focus { outline: none; border-color: #4f46e5; background: white; box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
  .editor-body { padding: 24px; flex: 1; overflow-y: auto; }
  .q-list { display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px; max-width: 900px; margin-left: auto; margin-right: auto; }

  .q-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; }
  .q-card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .q-card-top h3 { font-size: 0.8rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
  .type-badge { font-size: 0.75rem; font-weight: 600; border-radius: 20px; padding: 4px 12px; }
  .type-badge.single   { background: #eef2ff; color: #4f46e5; }
  .type-badge.multiple { background: #fef3c7; color: #d97706; }
  .type-toggle { display: flex; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; margin-bottom: 16px; }
  .type-toggle button { flex: 1; padding: 10px 0; border: none; background: white; font-size: 0.85rem; font-weight: 500; cursor: pointer; color: #6b7280; transition: all 0.2s; }
  .type-toggle button:hover { background: #f9fafb; }
  .type-toggle button.active-single   { background: #4f46e5; color: white; }
  .type-toggle button.active-multiple { background: #f59e0b; color: white; }
  .q-card textarea { width: 100%; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px 16px; font-size: 1rem; font-family: inherit; margin-bottom: 16px; resize: vertical; min-height: 70px; transition: all 0.2s; background: #fafbfc; }
  .q-card textarea:focus { outline: none; border-color: #4f46e5; background: white; box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }

  /* Image upload */
  .img-section { margin-bottom: 16px; }
  .img-section > label { font-size: 0.8rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 8px; }
  .img-drop-zone { border: 2px dashed #d1d5db; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafbfc; position: relative; }
  .img-drop-zone:hover, .img-drop-zone.drag-over { border-color: #4f46e5; background: #f5f3ff; }
  .img-drop-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .img-drop-zone .drop-label { font-size: 0.9rem; color: #6b7280; pointer-events: none; }
  .img-drop-zone .drop-label span { color: #4f46e5; font-weight: 500; }
  .img-preview-wrap { position: relative; display: inline-block; margin-top: 12px; }
  .img-preview { max-height: 140px; max-width: 100%; border-radius: 10px; display: block; object-fit: cover; }
  .img-remove-btn { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 26px; height: 26px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 600; transition: transform 0.2s; }
  .img-remove-btn:hover { transform: scale(1.1); }
  .img-uploading { font-size: 0.85rem; color: #4f46e5; margin-top: 8px; animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

  .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .ans-wrap { border-radius: 10px; padding: 12px 14px; display: flex; flex-direction: column; gap: 6px; border-width: 2px; border-style: solid; }
  .ans-wrap.c0 { background: #fef2f2; border-color: #fca5a5; }
  .ans-wrap.c1 { background: #eff6ff; border-color: #93c5fd; }
  .ans-wrap.c2 { background: #fefce8; border-color: #fde047; }
  .ans-wrap.c3 { background: #f0fdf4; border-color: #86efac; }
  .ans-wrap.c4 { background: #fff7ed; border-color: #fdba74; }
  .ans-wrap.c5 { background: #faf5ff; border-color: #d8b4fe; }
  .ans-wrap.c6 { background: #f9fafb; border-color: #9ca3af; }
  .ans-wrap.c7 { background: #f9fafb; border-color: #d1d5db; }
  .ans-wrap.c8 { background: #fef3c7; border-color: #fcd34d; }
  .ans-wrap.c9 { background: #fff7ed; border-color: #fdba74; }
  .ans-wrap.c10{ background: #ecfeff; border-color: #67e8f9; }
  .ans-wrap.c11{ background: #fce7f3; border-color: #f9a8d4; }
  .ans-wrap input[type=text] { border: none; background: transparent; font-size: 0.95rem; padding: 4px 6px; font-family: inherit; width: 100%; }
  .ans-wrap input[type=text]:focus { outline: none; }
  .ans-wrap label { font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 6px; cursor: pointer; color: #4b5563; }
  .q-footer { display: flex; align-items: center; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
  .ans-wrap { position: relative; }
  .ans-delete-btn {
    position: absolute; top: -8px; right: -8px;
    background: #ef4444; color: white; border: none; border-radius: 50%;
    width: 22px; height: 22px; font-size: 0.75rem; font-weight: 700;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.15s, transform 0.15s; z-index: 2;
  }
  .ans-wrap:hover .ans-delete-btn { opacity: 1; }
  .ans-delete-btn:hover { transform: scale(1.15); background: #dc2626; }
  .q-footer label { font-size: 0.85rem; color: #4b5563; display: flex; align-items: center; gap: 8px; }
  .q-footer select { border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 12px; font-size: 0.9rem; background: white; cursor: pointer; }
  .del-btn { margin-left: auto; background: #fef2f2; color: #ef4444; border: 1px solid #fecaca; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-weight: 500; font-size: 0.85rem; transition: all 0.2s; }
  .del-btn:hover { background: #fee2e2; }
  .ans-controls { display: flex; gap: 8px; margin-top: 12px; }
  .editor-footer { padding: 16px 24px; background: white; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; flex-wrap: wrap; }

  /* â”€â”€ VALIDATION ERRORS â”€â”€ */
  .q-card.has-error { border-color: #ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,0.15); }
  .field-error textarea,
  .field-error-textarea { border-color: #ef4444 !important; background: #fef2f2 !important; }
  .ans-wrap.field-error-answer { background: #fffbeb !important; border-color: #f59e0b !important; }
  .ans-wrap.field-error-answer input[type=text] { color: #b45309; }
  .correct-error-msg {
    font-size: 0.8rem; font-weight: 500; color: #ef4444;
    background: #fef2f2; border: 1px solid #fecaca;
    border-radius: 8px; padding: 8px 12px; margin-top: 8px;
  }
  @keyframes shake-card {
    0%,100% { transform: translateX(0); }
    20%,60% { transform: translateX(-6px); }
    40%,80% { transform: translateX(6px); }
  }
  .q-card.has-error { animation: shake-card 0.4s ease; }

  /* â”€â”€ LOBBY â”€â”€ */
  #lobby { background: linear-gradient(135deg, #4f46e5, #7c3aed); align-items: center; justify-content: flex-start; padding: 40px 24px; gap: 24px; }
  .pin-box { background: white; color: #1a1a2e; border-radius: 20px; padding: 28px 56px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
  .pin-box .lbl { font-size: 0.85rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 1.5px; }
  .pin-box .pin { font-size: clamp(2.5rem,10vw,4.5rem); font-weight: 800; color: #4f46e5; letter-spacing: 8px; }
  .pin-box .url { font-size: 0.9rem; color: #6b7280; margin-top: 8px; }
  #player-count { font-size: 1rem; color: rgba(255,255,255,0.85); font-weight: 500; }
  .players-wrap { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; max-width: 700px; }
  .p-chip { background: rgba(255,255,255,0.2); border-radius: 24px; padding: 10px 20px; font-weight: 500; animation: pop .3s ease; backdrop-filter: blur(4px); }
  @keyframes pop { from{transform:scale(0)} to{transform:scale(1)} }

  /* â”€â”€ QUESTION HOST â”€â”€ */
  #question-screen { background: linear-gradient(135deg, #4f46e5, #7c3aed); }
  .q-top { background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; gap: 12px; }
  .q-num { font-size: 0.9rem; color: rgba(255,255,255,0.8); font-weight: 500; }
  .q-type-pill { font-size: 0.75rem; font-weight: 600; padding: 4px 12px; border-radius: 20px; }
  .q-type-pill.single   { background: rgba(255,255,255,0.2); }
  .q-type-pill.multiple { background: rgba(255,255,255,0.2); }
  .timer { width: 64px; height: 64px; border-radius: 50%; background: white; color: #4f46e5; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; flex-shrink: 0; }
  .timer.urgent { color: #ef4444; }
  .ans-count-bar { background: rgba(0,0,0,0.15); padding: 12px 24px; font-size: 0.95rem; display: flex; gap: 16px; align-items: center; color: rgba(255,255,255,0.9); }
  .progress-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; }
  .progress-fill { height: 100%; background: #fbbf24; border-radius: 3px; transition: width 0.3s; }
  .q-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .q-body.has-image { flex-direction: row; }
  .q-image-panel { width: 40%; max-width: 380px; padding: 16px 0 16px 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .q-image-panel img { max-width: 100%; max-height: 200px; border-radius: 16px; object-fit: contain; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
  .q-right { flex: 1; display: flex; flex-direction: column; min-width: 0; }
  .q-text { display: flex; align-items: center; justify-content: center; font-size: clamp(1.1rem,2.5vw,1.8rem); font-weight: 600; text-align: center; padding: 20px 24px; flex: 1; }
  .a-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px 20px 20px; }
  .a-block { border-radius: 14px; padding: 16px; font-size: clamp(0.9rem,1.8vw,1.05rem); font-weight: 600; display: flex; align-items: center; gap: 12px; min-height: 70px; transition: all 0.25s; color: white; }
  .a-block .ico { font-size: 1.4rem; flex-shrink: 0; }
  .a-block.c0 { background: #ef4444; }
  .a-block.c1 { background: #3b82f6; }
  .a-block.c2 { background: #eab308; }
  .a-block.c3 { background: #22c55e; }
  .a-block.c4 { background: #f97316; }
  .a-block.c5 { background: #8b5cf6; }
  .a-block.c6 { background: #6b7280; }
  .a-block.c7 { background: #9ca3af; }
  .a-block.c8 { background: #a16207; }
  .a-block.c9 { background: #ea580c; }
  .a-block.c10{ background: #0891b2; }
  .a-block.c11{ background: #db2777; }
  .a-block.correct { outline: 4px solid white; transform: scale(1.03); }
  .a-block.wrong   { opacity: 0.35; }

  /* â”€â”€ Q RESULT â”€â”€ */
  #q-result { background: linear-gradient(135deg, #1e1b4b, #312e81); align-items: center; justify-content: flex-start; padding: 24px; gap: 20px; }
  #q-result h2 { font-size: 1.6rem; font-weight: 600; }
  .auto-next { font-size: 0.9rem; color: rgba(255,255,255,0.7); }
  .auto-progress { width: 200px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; }
  .auto-progress-fill { height: 100%; background: #fbbf24; border-radius: 3px; }
  .lb-table { width: 100%; max-width: 480px; }
  .lb-row { display: flex; align-items: center; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 18px; margin-bottom: 10px; font-weight: 500; gap: 12px; backdrop-filter: blur(4px); }
  .lb-rank  { font-size: 1.2rem; width: 36px; text-align: center; }
  .lb-name  { flex: 1; }
  .lb-score { color: #fbbf24; font-weight: 700; }
  .answer-bars { display: flex; gap: 10px; align-items: flex-end; height: 80px; flex-wrap: wrap; }
  .a-bar-wrap { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; min-width: 36px; }
  .a-bar { width: 100%; border-radius: 4px 4px 0 0; transition: height .5s ease; min-width: 36px; }
  .a-bar.c0{background:#ef4444} .a-bar.c1{background:#3b82f6} .a-bar.c2{background:#eab308}  .a-bar.c3{background:#22c55e}
  .a-bar.c4{background:#f97316} .a-bar.c5{background:#8b5cf6} .a-bar.c6{background:#6b7280}  .a-bar.c7{background:#9ca3af}
  .a-bar.c8{background:#a16207} .a-bar.c9{background:#ea580c} .a-bar.c10{background:#0891b2} .a-bar.c11{background:#db2777}
  .a-bar-count  { font-size: 0.85rem; font-weight: 600; }
  .correct-mark { font-size: 1.2rem; }

  /* â”€â”€ FINAL â”€â”€ */
  #final { background: linear-gradient(135deg, #4f46e5, #7c3aed); align-items: center; padding: 40px 24px; gap: 20px; }
  #final h1 { font-size: clamp(1.8rem,5vw,2.5rem); font-weight: 800; }
  .podium { display: flex; align-items: flex-end; justify-content: center; gap: 12px; max-width: 480px; width: 100%; }
  .pod { display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; }
  .pod-name  { font-weight: 600; font-size: 0.9rem; text-align: center; word-break: break-word; }
  .pod-score { font-size: 0.8rem; color: rgba(255,255,255,0.8); }
  .pod-bar   { width: 100%; border-radius: 10px 10px 0 0; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
  .pod-bar.r1{background:#fbbf24;height:120px} .pod-bar.r2{background:#9ca3af;height:90px} .pod-bar.r3{background:#b45309;height:65px}
  .full-lb { width: 100%; max-width: 480px; }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .btn-purple { background: #7c3aed; color: white; }
  .btn-green  { background: #22c55e; color: white; }
  .btn-red    { background: #ef4444; color: white; }
  .btn-white  { background: white;   color: #4f46e5; border: 1px solid #e5e7eb; }
  .btn-blue   { background: #3b82f6; color: white; }
  .btn-yellow { background: #fbbf24; color: #1a1a2e; }
  .btn-sm { padding: 8px 14px; font-size: 0.8rem; }

  #toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 14px 28px; border-radius: 12px; font-weight: 500; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999; white-space: nowrap; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
  #toast.show { opacity: 1; }

  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 24px; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: white; color: #1a1a2e; border-radius: 20px; padding: 28px; max-width: 400px; width: 100%; box-shadow: 0 24px 48px rgba(0,0,0,0.2); }
  .modal h3 { margin-bottom: 12px; font-size: 1.15rem; font-weight: 600; }
  .modal p  { margin-bottom: 24px; color: #6b7280; line-height: 1.6; }
  .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LIBRARY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="library" class="screen active">
  <div class="tabs">
    <div class="tab active">Mes quiz</div>
    <div class="tab" onclick="newQuiz()">Nouveau quiz</div>
  </div>
  <div class="lib-header">
    <h1>Kahoot Clone</h1>
    <button class="btn btn-yellow" onclick="newQuiz()">CrÃ©er un quiz</button>
  </div>
  <div class="quiz-grid" id="quiz-grid">
    <div class="empty-lib"><div class="icon">ðŸ“­</div><div>Aucun quiz sauvegardÃ©</div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EDITOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="editor" class="screen">
  <div class="editor-header">
    <div class="tabs" style="background:transparent;flex:1;border:none;">
      <div class="tab" onclick="switchTab('library')">Mes quiz</div>
      <div class="tab active">Ã‰diteur</div>
    </div>
    <input type="text" id="quiz-name" placeholder="Nom du quiz..." maxlength="60">
  </div>
  <div class="editor-body">
    <div class="q-list" id="q-list"></div>
  </div>
  <div class="editor-footer">
    <button class="btn btn-purple" onclick="addQuestion()">Ajouter une question</button>
    <button class="btn btn-green"  onclick="saveQuiz()">Sauvegarder</button>
    <button class="btn btn-blue"   onclick="createGame()">Lancer la partie</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="lobby" class="screen">
  <h2>En attente de joueurs...</h2>
  <div class="pin-box">
    <div class="lbl">Code du jeu</div>
    <div class="pin" id="pin-display">â€”â€”</div>
    <div class="url">Rejoindre sur <strong>localhost:3000/player.html</strong></div>
  </div>
  <div id="player-count">0 joueur(s) connectÃ©(s)</div>
  <div class="players-wrap" id="players-wrap"></div>
  <button class="btn btn-green" onclick="startGame()">DÃ©marrer</button>
</div>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• QUESTION HOST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="question-screen" class="screen">
  <div class="q-top">
    <span class="q-num" id="q-num">Question 1 / ?</span>
    <span class="q-type-pill" id="q-type-pill">Choix unique</span>
    <div class="timer" id="timer">20</div>
  </div>
  <div class="ans-count-bar">
    <span id="ans-count">0 / 0 rÃ©ponses</span>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
  </div>
  <div class="q-body" id="q-body">
    <div class="q-image-panel" id="q-image-panel" style="display:none;">
      <img id="q-image" src="" alt="illustration">
    </div>
    <div class="q-right">
      <div class="q-text" id="q-text"></div>
      <div class="a-grid" id="a-grid"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Q RESULT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="q-result" class="screen">
  <h2>RÃ©sultats</h2>
  <div>
    <div class="auto-next" id="auto-next-label">Prochaine question dans 5s...</div>
    <div class="auto-progress"><div class="auto-progress-fill" id="auto-fill" style="width:100%"></div></div>
  </div>
  <div class="answer-bars" id="answer-bars"></div>
  <div class="lb-table"    id="lb-table"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FINAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="final" class="screen">
  <h1>RÃ©sultats finaux</h1>
  <div class="podium"  id="podium"></div>
  <div class="full-lb" id="full-lb"></div>
  <button class="btn btn-white" onclick="switchTab('library')">Retour aux quiz</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL DELETE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="delete-modal">
  <div class="modal">
    <h3>Supprimer ce quiz ?</h3>
    <p>Cette action est irrÃ©versible. Les images associÃ©es seront aussi supprimÃ©es.</p>
    <div class="modal-actions">
      <button class="btn btn-white btn-sm" onclick="closeModal()">Annuler</button>
      <button class="btn btn-red   btn-sm" onclick="confirmDelete()">Supprimer</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// â”€â”€â”€ Palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getShape(i) {
  const shapes = ['ðŸ”´','ðŸ”µ','ðŸŸ¡','ðŸŸ¢','ðŸŸ ','ðŸŸ£','âš«','âšª','ðŸŸ¤','ðŸ”¶','ðŸ”·','ðŸ”¸'];
  return shapes[i] ?? `(${i + 1})`;
}

let ws, currentGame = { pin: null, timerInterval: null, autoInterval: null };
let currentQuizId = null, pendingDeleteId = null;
let questions = [];

// â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS(pin) {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}`);
  ws.onopen    = () => ws.send(JSON.stringify({ type: 'host_join', pin }));
  ws.onmessage = e => handleMessage(JSON.parse(e.data));
  ws.onclose   = () => toast('Connexion perdue');
}
function send(obj) {
  if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
}

function handleMessage(msg) {
  switch (msg.type) {
    case 'host_joined':
      showScreen('lobby');
      break;
    case 'player_joined':
      document.getElementById('player-count').textContent = `${msg.count} joueur(s) connectÃ©(s)`;
      const chip = document.createElement('div');
      chip.className   = 'p-chip';
      chip.textContent = msg.name;
      document.getElementById('players-wrap').appendChild(chip);
      break;
    case 'player_left':
      document.getElementById('player-count').textContent = `${msg.count} joueur(s) connectÃ©(s)`;
      break;
    case 'question':
      showQuestion(msg);
      break;
    case 'answer_count':
      document.getElementById('ans-count').textContent     = `${msg.count} / ${msg.total} rÃ©ponses`;
      document.getElementById('progress-fill').style.width = `${(msg.count / msg.total) * 100}%`;
      break;
    case 'question_result':
      clearInterval(currentGame.timerInterval);
      showQResult(msg);
      break;
    case 'game_over':
      clearInterval(currentGame.timerInterval);
      clearInterval(currentGame.autoInterval);
      showFinal(msg.leaderboard);
      break;
    case 'error':
      toast(msg.message);
      break;
  }
}

// â”€â”€â”€ Library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLibrary() {
  const quizzes = await fetch('/api/quizzes').then(r => r.json()).catch(() => []);
  const grid = document.getElementById('quiz-grid');
  if (!quizzes.length) {
    grid.innerHTML = '<div class="empty-lib"><div class="icon">ðŸ“­</div><div>Aucun quiz sauvegardÃ©</div></div>';
    return;
  }
  grid.innerHTML = '';
  quizzes.forEach(q => {
    const card = document.createElement('div');
    card.className = 'quiz-card';
    card.innerHTML = `
      <h3>${q.name}</h3>
      <div class="meta">${q.questionCount} question(s) Â· ${new Date(q.createdAt).toLocaleDateString('fr-FR')}</div>
      <div class="quiz-card-actions">
        <button class="btn btn-blue  btn-sm" onclick="editQuiz('${q.id}',event)">Ã‰diter</button>
        <button class="btn btn-green btn-sm" onclick="launchQuiz('${q.id}',event)">Lancer</button>
        <button class="btn btn-red   btn-sm" onclick="askDelete('${q.id}',event)">Supprimer</button>
      </div>`;
    grid.appendChild(card);
  });
}

async function editQuiz(id, e) {
  e && e.stopPropagation();
  const quiz = await fetch(`/api/quizzes/${id}`).then(r => r.json());
  currentQuizId = id;
  questions     = quiz.questions;
  document.getElementById('quiz-name').value = quiz.name;
  renderEditor();
  showScreen('editor');
}

async function launchQuiz(id, e) {
  e && e.stopPropagation();
  const quiz = await fetch(`/api/quizzes/${id}`).then(r => r.json());
  questions = quiz.questions;
  await doCreateGame();
}

function askDelete(id, e) {
  e && e.stopPropagation();
  pendingDeleteId = id;
  document.getElementById('delete-modal').classList.add('open');
}
function closeModal() {
  document.getElementById('delete-modal').classList.remove('open');
  pendingDeleteId = null;
}
async function confirmDelete() {
  if (!pendingDeleteId) return closeModal();
  await fetch(`/api/quizzes/${pendingDeleteId}`, { method: 'DELETE' });
  closeModal();
  toast('Quiz supprimÃ©');
  loadLibrary();
}

// â”€â”€â”€ Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newQuiz() {
  currentQuizId = null;
  questions = [{ question: '', answers: ['', '', '', ''], correct: 0, time: 20, type: 'single', image: null }];
  document.getElementById('quiz-name').value = '';
  renderEditor();
  showScreen('editor');
}

function renderEditor() {
  const list = document.getElementById('q-list');
  list.innerHTML = '';

  questions.forEach((q, i) => {
    const isMultiple = q.type === 'multiple';
    const correctArr = isMultiple
      ? (Array.isArray(q.correct) ? q.correct : [q.correct])
      : [];

    const card = document.createElement('div');
    card.className = 'q-card';

    card.innerHTML = `
      <div class="q-card-top">
        <h3>Question ${i + 1}</h3>
        <span class="type-badge ${isMultiple ? 'multiple' : 'single'}">${isMultiple ? 'Choix multiple' : 'Choix unique'}</span>
      </div>
      <div class="type-toggle">
        <button class="${!isMultiple ? 'active-single' : ''}"   onclick="setQuestionType(${i},'single')">Choix unique</button>
        <button class="${isMultiple  ? 'active-multiple' : ''}" onclick="setQuestionType(${i},'multiple')">Choix multiple</button>
      </div>
      <textarea placeholder="Texte de la question..."></textarea>

      <div class="img-section">
        <label>Image d'illustration (optionnel)</label>
        <div id="img-zone-${i}">
          ${q.image
            ? `<div class="img-preview-wrap">
                 <img class="img-preview" src="${q.image}" alt="illustration">
                 <button class="img-remove-btn" onclick="removeImage(${i})" title="Supprimer">âœ•</button>
               </div>`
            : `<div class="img-drop-zone" id="drop-zone-${i}">
                 <input type="file" accept="image/*" onchange="uploadImage(${i}, this.files[0])">
                 <div class="drop-label">Glisse une image ici ou <span>clique pour choisir</span><br><small>JPG, PNG, GIF, WebP Â· max 5 Mo</small></div>
               </div>`
          }
          <div class="img-uploading" id="img-loading-${i}" style="display:none;">Upload en cours...</div>
        </div>
      </div>

      <div class="answers-grid" id="ans-grid-${i}">
        ${q.answers.map((_, j) => `
          <div class="ans-wrap c${j % 12}">
            ${q.answers.length > 2 ? `<button class="ans-delete-btn" onclick="removeAnswerAt(${i},${j})" title="Supprimer cette rÃ©ponse">âœ•</button>` : ''}
            <input type="text" placeholder="RÃ©ponse ${j + 1}">
            <label>
              ${isMultiple
                ? `<input type="checkbox" ${correctArr.includes(j) ? 'checked' : ''}> ${getShape(j)} Bonne rÃ©ponse`
                : `<input type="radio" name="correct-${i}" ${q.correct === j ? 'checked' : ''}> ${getShape(j)} Bonne rÃ©ponse`
              }
            </label>
          </div>`).join('')}
      </div>

      <div class="ans-controls">
        <button class="btn btn-purple btn-sm" onclick="addAnswer(${i})">Ajouter une rÃ©ponse</button>
      </div>

      <div class="q-footer">
        <label>Temps :
          <select>
            ${[5, 10, 15, 20, 30, 60].map(t => `<option value="${t}" ${q.time === t ? 'selected' : ''}>${t}s</option>`).join('')}
          </select>
        </label>
        <button class="del-btn" onclick="deleteQuestion(${i})">Supprimer</button>
      </div>`;

    list.appendChild(card);

    // Valeurs APRÃˆS insertion dans le DOM
    card.querySelector('textarea').value = q.question;
    const ansInputs = card.querySelectorAll('.ans-wrap input[type=text]');
    ansInputs.forEach((input, j) => { input.value = q.answers[j] || ''; });

    // Drag & drop image
    const zone = card.querySelector(`#drop-zone-${i}`);
    if (zone) {
      zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('drag-over'); });
      zone.addEventListener('dragleave', ()  => zone.classList.remove('drag-over'));
      zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file) uploadImage(i, file);
      });
    }
  });
}

// â”€â”€â”€ Sync DOM â†’ questions[] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncFromDOM() {
  const cards = Array.from(document.querySelectorAll('#q-list .q-card'));
  cards.forEach((card, i) => {
    if (!questions[i]) return;

    const textarea = card.querySelector('textarea');
    if (textarea) questions[i].question = textarea.value;

    const ansWraps = card.querySelectorAll('.ans-wrap');
    ansWraps.forEach((wrap, j) => {
      const input = wrap.querySelector('input[type=text]');
      if (input) questions[i].answers[j] = input.value;
    });

    if (questions[i].type !== 'multiple') {
      const radios = card.querySelectorAll('input[type=radio]');
      radios.forEach((radio, j) => {
        if (radio.checked) questions[i].correct = j;
      });
    }

    if (questions[i].type === 'multiple') {
      const checkboxes = card.querySelectorAll('input[type=checkbox]');
      questions[i].correct = [];
      checkboxes.forEach((cb, j) => {
        if (cb.checked) questions[i].correct.push(j);
      });
    }

    const select = card.querySelector('.q-footer select');
    if (select) questions[i].time = parseInt(select.value);
  });
}

// â”€â”€â”€ Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validateQuestions() {
  syncFromDOM();
  clearAllValidationErrors();
  let firstErrorCard = null;
  let valid = true;

  for (let i = 0; i < questions.length; i++) {
    const q = questions[i];
    const card = document.querySelectorAll('#q-list .q-card')[i];
    if (!card) continue;
    let cardHasError = false;

    // Texte de la question vide
    if (!q.question.trim()) {
      const ta = card.querySelector('textarea');
      if (ta) ta.classList.add('field-error-textarea');
      cardHasError = true;
      valid = false;
    }

    // RÃ©ponses vides
    const ansWraps = card.querySelectorAll('.ans-wrap');
    ansWraps.forEach((wrap, j) => {
      if (!q.answers[j] || !q.answers[j].trim()) {
        wrap.classList.add('field-error-answer');
        cardHasError = true;
        valid = false;
      }
    });

    // Aucune bonne rÃ©ponse cochÃ©e (choix multiple)
    if (q.type === 'multiple' && (!Array.isArray(q.correct) || q.correct.length === 0)) {
      showCorrectError(card, 'Cochez au moins une bonne rÃ©ponse');
      cardHasError = true;
      valid = false;
    }

    // Aucune bonne rÃ©ponse sÃ©lectionnÃ©e (choix unique â€” cas rare mais possible si correct=-1)
    if (q.type === 'single' && (q.correct == null || q.correct < 0)) {
      showCorrectError(card, 'SÃ©lectionnez une bonne rÃ©ponse');
      cardHasError = true;
      valid = false;
    }

    if (cardHasError) {
      card.classList.add('has-error');
      if (!firstErrorCard) firstErrorCard = card;
    }
  }

  if (!valid) {
    const errorCount = document.querySelectorAll('.q-card.has-error').length;
    toast(`${errorCount} question(s) incomplÃ¨te(s) â€” champs en rouge Ã  corriger`);
    setTimeout(() => firstErrorCard?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
  }

  return valid;
}

function clearAllValidationErrors() {
  document.querySelectorAll('.q-card.has-error').forEach(c => c.classList.remove('has-error'));
  document.querySelectorAll('.field-error-textarea').forEach(el => el.classList.remove('field-error-textarea'));
  document.querySelectorAll('.field-error-answer').forEach(el => el.classList.remove('field-error-answer'));
  document.querySelectorAll('.correct-error-msg').forEach(el => el.remove());
}

function showCorrectError(card, message) {
  if (card.querySelector('.correct-error-msg')) return;
  const el = document.createElement('div');
  el.className   = 'correct-error-msg';
  el.textContent = message;
  const controls = card.querySelector('.ans-controls');
  if (controls) controls.insertAdjacentElement('afterend', el);
}

// â”€â”€â”€ Type de question â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setQuestionType(i, type) {
  syncFromDOM();
  questions[i].type = type;
  if (type === 'multiple') {
    const prev = questions[i].correct;
    questions[i].correct = typeof prev === 'number' ? [prev] : (Array.isArray(prev) ? prev : [0]);
  } else {
    const prev = questions[i].correct;
    questions[i].correct = Array.isArray(prev) ? (prev[0] ?? 0) : (typeof prev === 'number' ? prev : 0);
  }
  renderEditor();
}

// â”€â”€â”€ Questions CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addQuestion() {
  syncFromDOM();
  questions.push({ question: '', answers: ['', '', '', ''], correct: 0, time: 20, type: 'single', image: null });
  renderEditor();
  setTimeout(() => document.getElementById('q-list').lastElementChild?.scrollIntoView({ behavior: 'smooth' }), 50);
}

function deleteQuestion(i) {
  if (questions.length <= 1) return toast('Minimum 1 question');
  syncFromDOM();
  const url = questions[i].image;
  if (url) fetch('/api/upload', {
    method: 'DELETE',
    body:   JSON.stringify({ url }),
  }).catch(() => {});
  questions.splice(i, 1);
  renderEditor();
}

// â”€â”€â”€ RÃ©ponses CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addAnswer(i) {
  syncFromDOM();
  if (questions[i].answers.length >= 12) return toast('Maximum 12 rÃ©ponses');
  questions[i].answers.push('');
  renderEditor();
  setTimeout(() => {
    const card = document.querySelectorAll('#q-list .q-card')[i];
    card?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 50);
}

function removeAnswer(i) {
  syncFromDOM();
  const q = questions[i];
  if (q.answers.length <= 2) return toast('Minimum 2 rÃ©ponses');
  q.answers.pop();
  // Nettoyer la bonne rÃ©ponse si elle pointait sur la case supprimÃ©e
  if (q.type === 'multiple') {
    q.correct = (Array.isArray(q.correct) ? q.correct : []).filter(c => c < q.answers.length);
    if (q.correct.length === 0) q.correct = [0];
  } else {
    if (q.correct >= q.answers.length) q.correct = q.answers.length - 1;
  }
  renderEditor();
}

function removeAnswerAt(i, j) {
  syncFromDOM();
  const q = questions[i];
  if (q.answers.length <= 2) return toast('Minimum 2 rÃ©ponses');
  q.answers.splice(j, 1);
  if (q.type === 'multiple') {
    q.correct = (Array.isArray(q.correct) ? q.correct : [])
      .filter(c => c !== j)
      .map(c => c > j ? c - 1 : c);
    if (q.correct.length === 0) q.correct = [0];
  } else {
    if (q.correct === j) q.correct = 0;
    else if (q.correct > j) q.correct--;
  }
  renderEditor();
}

// â”€â”€â”€ Images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadImage(i, file) {
  if (!file) return;
  const MAX_MB = 5;
  if (file.size > MAX_MB * 1024 * 1024) {
    const fileMb = (file.size / (1024 * 1024)).toFixed(1);
    toast(`Image trop lourde (${fileMb} Mo) â€” maximum ${MAX_MB} Mo`, 5000);
    showImgError(i, `Fichier trop volumineux : ${fileMb} Mo (max ${MAX_MB} Mo)`);
    return;
  }
  const allowed = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  if (!allowed.includes(file.type)) {
    toast(`Format non supportÃ© : ${file.type || 'inconnu'}`, 4000);
    showImgError(i, 'Format non supportÃ©. Utilise JPG, PNG, GIF ou WebP.');
    return;
  }
  const loading = document.getElementById(`img-loading-${i}`);
  if (loading) loading.style.display = 'block';
  hideImgError(i);
  const form = new FormData();
  form.append('image', file);
  try {
    const res  = await fetch('/api/upload', { method: 'POST', body: form });
    const data = await res.json();
    if (!res.ok) {
      toast(data.error, 5000);
      showImgError(i, data.detail || data.error || 'Erreur inconnue');
      return;
    }
    if (questions[i].image) {
      await fetch('/api/upload', {
        method: 'DELETE',
        body:   JSON.stringify({ url: questions[i].image }),
      }).catch(() => {});
    }
    questions[i].image = data.url;
    toast(`Image uploadÃ©e (${data.sizeMb} Mo)`, 2500);
    renderEditor();
    setTimeout(() => document.getElementById('q-list').children[i]
      ?.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
  } catch {
    toast('Impossible de contacter le serveur', 4000);
    showImgError(i, 'Erreur rÃ©seau. VÃ©rifie ta connexion et rÃ©essaie.');
  } finally {
    if (loading) loading.style.display = 'none';
  }
}

async function removeImage(i) {
  const url = questions[i].image;
  if (url) await fetch('/api/upload', {
    method: 'DELETE',
    body:   JSON.stringify({ url }),
  }).catch(() => {});
  questions[i].image = null;
  renderEditor();
}

function showImgError(i, message) {
  let el = document.getElementById(`img-error-${i}`);
  if (!el) {
    el = document.createElement('div');
    el.id = `img-error-${i}`;
    el.style.cssText = 'color:#ef4444;font-size:.8rem;font-weight:500;margin-top:8px;'
      + 'padding:8px 12px;background:#fef2f2;border-radius:8px;border:1px solid #fecaca;';
    const zone = document.getElementById(`img-zone-${i}`);
    if (zone) zone.appendChild(el);
  }
  el.textContent   = message;
  el.style.display = 'block';
}
function hideImgError(i) {
  const el = document.getElementById(`img-error-${i}`);
  if (el) el.style.display = 'none';
}

// â”€â”€â”€ Save / Create â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveQuiz() {
  const name = document.getElementById('quiz-name').value.trim();
  if (!name) return toast('Donne un nom au quiz');
  if (!validateQuestions()) return;
  const res = await fetch('/api/quizzes', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body:   JSON.stringify({ name, questions, id: currentQuizId }),
  });
  const data = await res.json();
  if (!res.ok) return toast(data.error);
  currentQuizId = data.id;
  toast('Quiz sauvegardÃ© !');
}

async function createGame() {
  if (!validateQuestions()) return;
  await doCreateGame();
}

async function doCreateGame() {
  const res = await fetch('/api/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body:   JSON.stringify({ questions }),
  });
  const data = await res.json();
  if (!res.ok) return toast(data.error);
  currentGame.pin = data.pin;
  document.getElementById('pin-display').textContent  = data.pin;
  document.getElementById('players-wrap').innerHTML   = '';
  document.getElementById('player-count').textContent = '0 joueur(s) connectÃ©(s)';
  connectWS(data.pin);
}

function startGame() {
  send({ type: 'start_game', pin: currentGame.pin });
}

// â”€â”€â”€ Question (hÃ´te) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showQuestion(msg) {
  showScreen('question-screen');
  clearInterval(currentGame.autoInterval);
  document.getElementById('q-num').textContent         = `Question ${msg.index + 1} / ${msg.total}`;
  document.getElementById('q-text').textContent        = msg.question;
  document.getElementById('ans-count').textContent     = '0 / ? rÃ©ponses';
  document.getElementById('progress-fill').style.width = '0%';

  const pill = document.getElementById('q-type-pill');
  pill.textContent = msg.questionType === 'multiple' ? 'Choix multiple' : 'Choix unique';
  pill.className   = `q-type-pill ${msg.questionType === 'multiple' ? 'multiple' : 'single'}`;

  const imgPanel = document.getElementById('q-image-panel');
  const imgEl    = document.getElementById('q-image');
  const body     = document.getElementById('q-body');
  if (msg.image) {
    imgEl.src = msg.image;
    imgPanel.style.display = 'flex';
    body.classList.add('has-image');
  } else {
    imgPanel.style.display = 'none';
    body.classList.remove('has-image');
  }

  const grid = document.getElementById('a-grid');
  grid.innerHTML = '';

  // Adapter le nombre de colonnes selon le nombre de rÃ©ponses
  const n = msg.answers.length;
  grid.style.gridTemplateColumns = n <= 4 ? '1fr 1fr'
                                 : n <= 6 ? '1fr 1fr 1fr'
                                 : '1fr 1fr 1fr 1fr';

  msg.answers.forEach((a, i) => {
    const div = document.createElement('div');
    div.className = `a-block c${i % 12}`;
    div.innerHTML = `<span class="ico">${getShape(i)}</span>`;
    const span = document.createElement('span');
    span.textContent = a;
    div.appendChild(span);
    grid.appendChild(div);
  });

  let t = msg.time;
  const timerEl = document.getElementById('timer');
  timerEl.textContent = t;
  timerEl.classList.remove('urgent');
  clearInterval(currentGame.timerInterval);
  currentGame.timerInterval = setInterval(() => {
    t--;
    timerEl.textContent = t;
    if (t <= 5) timerEl.classList.add('urgent');
    if (t <= 0) clearInterval(currentGame.timerInterval);
  }, 1000);
}

// â”€â”€â”€ Q Result (hÃ´te) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showQResult(msg) {
  showScreen('q-result');
  document.getElementById('auto-next-label').textContent =
    msg.isLast ? 'RÃ©sultats finaux dans 5sâ€¦' : 'Prochaine question dans 5sâ€¦';

  const correctArr = Array.isArray(msg.correct) ? msg.correct : [msg.correct];
  document.querySelectorAll('.a-block').forEach((b, i) =>
    b.classList.add(correctArr.includes(i) ? 'correct' : 'wrong')
  );

  let pct = 100;
  const fill = document.getElementById('auto-fill');
  fill.style.width = '100%';
  clearInterval(currentGame.autoInterval);
  currentGame.autoInterval = setInterval(() => {
    pct -= 2;
    fill.style.width = `${Math.max(0, pct)}%`;
    if (pct <= 0) clearInterval(currentGame.autoInterval);
  }, 100);

  const counts   = msg.answerCounts || [];
  const maxCount = Math.max(...counts, 1);
  document.getElementById('answer-bars').innerHTML = counts.map((c, i) => `
    <div class="a-bar-wrap">
      <span class="a-bar-count">${c}</span>
      <div class="a-bar c${i % 12}" style="height:${Math.round((c / maxCount) * 70)}px"></div>
      <span class="correct-mark">${correctArr.includes(i) ? 'âœ…' : ''}</span>
    </div>`).join('');

  const rankEmojis = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
  document.getElementById('lb-table').innerHTML = msg.leaderboard.slice(0, 5).map((p, i) => `
    <div class="lb-row">
      <span class="lb-rank">${rankEmojis[i] || p.rank}</span>
      <span class="lb-name">${p.name}</span>
      <span class="lb-score">${p.score} pts</span>
    </div>`).join('');
}

// â”€â”€â”€ Final â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showFinal(leaderboard) {
  showScreen('final');
  const order = [1, 0, 2], heights = ['r2', 'r1', 'r3'], emojis = ['ðŸ¥ˆ', 'ðŸ¥‡', 'ðŸ¥‰'];
  document.getElementById('podium').innerHTML = order.map((idx, pos) => {
    const p = leaderboard[idx];
    if (!p) return '';
    return `<div class="pod">
      <div class="pod-name">${p.name}</div>
      <div class="pod-score">${p.score} pts</div>
      <div class="pod-bar ${heights[pos]}">${emojis[pos]}</div>
    </div>`;
  }).join('');
  document.getElementById('full-lb').innerHTML = leaderboard.map((p, i) => `
    <div class="lb-row">
      <span class="lb-rank">${['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][i] || '#' + p.rank}</span>
      <span class="lb-name">${p.name}</span>
      <span class="lb-score">${p.score} pts</span>
    </div>`).join('');
}

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  if (tab === 'library') { loadLibrary(); showScreen('library'); }
}
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function toast(msg, d = 3000) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), d);
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadLibrary();
</script>
</body>
</html>