<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kahoot Clone ‚Äì Joueur</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #f8f9fb; color: #1a1a2e; min-height: 100vh; line-height: 1.5; }
  .screen { display: none; min-height: 100vh; flex-direction: column; align-items: center; justify-content: center; padding: 24px; }
  .screen.active { display: flex; }

  #join { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; }
  #join h1 { font-size: clamp(1.8rem,6vw,2.5rem); font-weight: 800; margin-bottom: 8px; }
  #join p { opacity: .8; margin-bottom: 32px; }
  .input-group { display: flex; flex-direction: column; gap: 14px; width: 100%; max-width: 340px; }
  .input-group input { padding: 16px 20px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; text-align: center; color: #1a1a2e; outline: none; background: white; }
  .input-group input::placeholder { color: #9ca3af; font-weight: 400; }
  .input-group input:focus { box-shadow: 0 0 0 3px rgba(255,255,255,0.3); }
  .error-msg { color: #fecaca; font-size: .9rem; font-weight: 500; min-height: 20px; text-align: center; }

  #lobby { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; text-align: center; gap: 16px; }
  .my-name { font-size: clamp(2rem,8vw,3.5rem); font-weight: 800; }
  .waiting { font-size: 1rem; opacity: .8; animation: pulse 1.8s infinite; }
  @keyframes pulse { 0%,100%{opacity:.8} 50%{opacity:.4} }
  .avatar { font-size: 4rem; margin-bottom: 8px; }

  /* ‚îÄ‚îÄ QUESTION ‚îÄ‚îÄ */
  #question-screen { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; justify-content: flex-start; padding: 0; }
  .q-header { background: rgba(0,0,0,0.2); width: 100%; padding: 14px 24px; text-align: center; }
  .q-timer { font-size: 2rem; font-weight: 800; }
  .q-timer.urgent { color: #fca5a5; animation: shake .3s infinite; }
  @keyframes shake { 0%,100%{transform:rotate(-2deg)} 50%{transform:rotate(2deg)} }
  .q-type-banner { font-size: 0.8rem; font-weight: 600; padding: 6px 14px; border-radius: 20px; display: inline-block; margin-top: 6px; background: rgba(255,255,255,0.15); }
  .q-type-banner.single   { background: rgba(255,255,255,0.15); }
  .q-type-banner.multiple { background: rgba(255,255,255,0.15); }

  .q-player-image { width: 100%; padding: 12px 20px 0; display: flex; justify-content: center; }
  .q-player-image img { max-height: 130px; max-width: 100%; border-radius: 12px; object-fit: contain; box-shadow: 0 8px 24px rgba(0,0,0,0.3); }

  .q-body-text { font-size: clamp(1rem,2.5vw,1.3rem); font-weight: 600; padding: 14px 24px; text-align: center; width: 100%; }

  /* Boutons choix unique */
  .a-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px 20px 20px; width: 100%; }
  .a-btn { border: none; border-radius: 14px; padding: 16px 12px; font-size: clamp(.85rem,2vw,1rem); font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; min-height: 85px; transition: all 0.2s; color: white; }
  .a-btn:hover:not(:disabled) { transform: scale(1.04); filter: brightness(1.1); }
  .a-btn:disabled { cursor: default; }
  .a-btn .ico { font-size: 1.6rem; }
  .a-btn.c0 {background:#ef4444} .a-btn.c1 {background:#3b82f6} .a-btn.c2 {background:#eab308} .a-btn.c3 {background:#22c55e}
  .a-btn.c4 {background:#f97316} .a-btn.c5 {background:#8b5cf6} .a-btn.c6 {background:#6b7280} .a-btn.c7 {background:#9ca3af}
  .a-btn.c8 {background:#a16207} .a-btn.c9 {background:#ea580c} .a-btn.c10{background:#0891b2} .a-btn.c11{background:#db2777}

  /* Boutons choix multiple */
  .a-checkboxes { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px 20px 0; width: 100%; }
  .a-check-btn { border: 3px solid transparent; border-radius: 14px; padding: 14px 12px; font-size: clamp(.85rem,2vw,1rem); font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; min-height: 85px; transition: all 0.2s; color: white; position: relative; }
  .a-check-btn:hover:not(.disabled) { filter: brightness(1.1); }
  .a-check-btn.c0 {background:#ef4444} .a-check-btn.c1 {background:#3b82f6} .a-check-btn.c2 {background:#eab308} .a-check-btn.c3 {background:#22c55e}
  .a-check-btn.c4 {background:#f97316} .a-check-btn.c5 {background:#8b5cf6} .a-check-btn.c6 {background:#6b7280} .a-check-btn.c7 {background:#9ca3af}
  .a-check-btn.c8 {background:#a16207} .a-check-btn.c9 {background:#ea580c} .a-check-btn.c10{background:#0891b2} .a-check-btn.c11{background:#db2777}
  .a-check-btn.checked { border-color: white; transform: scale(1.04); filter: brightness(1.15); }
  .a-check-btn.disabled { cursor: default; opacity: .7; }
  .check-indicator { position: absolute; top: 8px; right: 10px; font-size: 1.1rem; }
  .a-check-btn .ico { font-size: 1.6rem; }
  .submit-bar { padding: 12px 20px 20px; width: 100%; }
  .submit-btn { width: 100%; padding: 16px; border: none; border-radius: 14px; background: #fbbf24; color: #1a1a2e; font-size: 1rem; font-weight: 800; cursor: pointer; transition: all 0.2s; }
  .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .submit-btn:disabled { opacity: .5; cursor: default; }

  #answered { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; text-align: center; gap: 16px; }
  .answered-icon { font-size: 4rem; }
  #answered h2 { font-size: 1.5rem; font-weight: 600; }
  #answered p { opacity: .8; }
  .pts { font-size: 2.2rem; font-weight: 800; color: #fbbf24; }

  #q-result { background: linear-gradient(135deg, #1e1b4b, #312e81); color: white; text-align: center; gap: 14px; }
  #q-result h2 { font-size: 1.5rem; font-weight: 600; }
  .result-icon { font-size: 3.5rem; }
  .my-rank { font-size: 1rem; opacity: .85; }
  .lb-mini { width: 100%; max-width: 380px; }
  .lb-row { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,.12); border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; font-weight: 500; backdrop-filter: blur(4px); }
  .lb-row.me { background: rgba(255,255,255,.25); }
  .lb-rank { font-size: 1.1rem; width: 30px; text-align: center; }
  .lb-name { flex: 1; }
  .lb-score { color: #fbbf24; font-weight: 700; }

  #final { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; text-align: center; gap: 14px; }
  #final h1 { font-size: clamp(1.6rem,5vw,2.4rem); font-weight: 800; }
  .final-rank { font-size: 4rem; }
  .final-pts { font-size: 1.6rem; font-weight: 800; color: #fbbf24; }
  .full-lb { width: 100%; max-width: 380px; }

  .btn { padding: 14px 32px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,.2); }
  .btn-white { background: white; color: #4f46e5; }

  #toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 14px 28px; border-radius: 12px; font-weight: 500; opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 999; white-space: nowrap; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
  #toast.show { opacity: 1; }
</style>
</head>
<body>

<!-- JOIN -->
<div id="join" class="screen active">
  <h1>Rejoindre</h1>
  <p>Entre le code de la partie et ton pseudo</p>
  <div class="input-group">
    <input id="pin-input" type="text" inputmode="numeric" placeholder="Code du jeu" maxlength="6">
    <input id="name-input" type="text" placeholder="Ton pr√©nom" maxlength="20">
    <div class="error-msg" id="err-msg"></div>
    <button class="btn" style="background:#22c55e;color:white;" onclick="joinGame()">Rejoindre</button>
  </div>
</div>

<!-- LOBBY -->
<div id="lobby" class="screen">
  <div class="avatar" id="avatar">üé≠</div>
  <h2>Tu es dans la partie !</h2>
  <div class="my-name" id="my-name-display">?</div>
  <div class="waiting">En attente du d√©but...</div>
</div>

<!-- QUESTION -->
<div id="question-screen" class="screen" style="padding:0;justify-content:flex-start;">
  <div class="q-header">
    <div class="q-timer" id="q-timer">20</div>
    <div id="q-progress" style="font-size:.8rem;opacity:.7;margin-top:4px;">Question 1</div>
    <div id="q-type-banner" class="q-type-banner single">Choix unique</div>
  </div>
  <div class="q-player-image" id="q-player-image" style="display:none;">
    <img id="q-player-img" src="" alt="illustration">
  </div>
  <div class="q-body-text"  id="q-body-text">‚Ä¶</div>
  <div class="a-buttons"    id="a-buttons"></div>
  <div class="a-checkboxes" id="a-checkboxes" style="display:none;"></div>
  <div class="submit-bar"   id="submit-bar"   style="display:none;">
    <button class="submit-btn" id="submit-btn" onclick="submitMultiple()">Valider mes r√©ponses</button>
  </div>
</div>

<!-- ANSWERED -->
<div id="answered" class="screen">
  <div class="answered-icon" id="ans-icon">‚úÖ</div>
  <h2 id="ans-title">R√©ponse enregistr√©e !</h2>
  <p id="ans-sub">En attente des autres joueurs...</p>
  <div class="pts" id="ans-pts"></div>
</div>

<!-- Q RESULT -->
<div id="q-result" class="screen">
  <div class="result-icon" id="result-icon">üéØ</div>
  <h2 id="result-title">Bonne r√©ponse !</h2>
  <div class="pts" id="result-pts"></div>
  <div class="my-rank" id="my-rank"></div>
  <div class="lb-mini" id="lb-mini"></div>
</div>

<!-- FINAL -->
<div id="final" class="screen">
  <h1>Partie termin√©e !</h1>
  <div class="final-rank" id="final-rank">üéñ</div>
  <div class="final-pts"  id="final-pts"></div>
  <div class="full-lb"    id="full-lb"></div>
  <button class="btn btn-white" style="margin-top:12px;" onclick="location.reload()">Rejouer</button>
</div>

<div id="toast"></div>

<script>
const AVATARS = ['üòé','ü¶ä','üêº','ü¶Å','üê∏','ü¶Ñ','üêØ','üêß','ü¶ã','ü¶ñ','üéÉ','üëæ'];

function getShape(i) {
  const shapes = ['üî¥','üîµ','üü°','üü¢','üü†','üü£','‚ö´','‚ö™','üü§','üî∂','üî∑','üî∏'];
  return shapes[i] ?? `(${i + 1})`;
}

let ws, myName='', myPlayerId='', gamePin='';
let timerInterval=null, submitted=false;
let lastAnswer={ given:null, correct:null, points:0 };
let myScore=0, currentQuestionType='single';
let multipleSelection=new Set();

function joinGame() {
  const pin  = document.getElementById('pin-input').value.trim();
  const name = document.getElementById('name-input').value.trim();
  const err  = document.getElementById('err-msg');
  err.textContent = '';
  if (!pin || pin.length < 4) return (err.textContent = 'Code invalide');
  if (!name || name.length < 2) return (err.textContent = 'Pseudo trop court');
  fetch(`/api/check/${pin}`)
    .then(r => r.json())
    .then(data => { if (data.error) return (err.textContent=data.error); gamePin=pin; myName=name; connectWS(); })
    .catch(() => (err.textContent='Serveur inaccessible'));
}

function connectWS() {
  const proto = location.protocol==='https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}`);
  ws.onopen    = () => ws.send(JSON.stringify({ type:'player_join', pin:gamePin, name:myName }));
  ws.onmessage = e => handleMsg(JSON.parse(e.data));
  ws.onclose   = () => toast('Connexion perdue');
}
function send(obj) { if (ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify(obj)); }

function handleMsg(msg) {
  switch (msg.type) {
    case 'joined':
      myPlayerId=msg.playerId;
      document.getElementById('my-name-display').textContent=myName;
      document.getElementById('avatar').textContent=AVATARS[Math.floor(Math.random()*AVATARS.length)];
      showScreen('lobby'); break;
    case 'question':
      lastAnswer={given:null,correct:null,points:0}; submitted=false; multipleSelection=new Set();
      showQuestionScreen(msg); break;
    case 'answer_received':
      clearInterval(timerInterval);
      lastAnswer.correct=msg.correct; lastAnswer.points=msg.points;
      if (msg.correct) myScore+=msg.points;
      showAnswered(msg.correct, msg.points); break;
    case 'question_result': showQResult(msg); break;
    case 'game_over':   clearInterval(timerInterval); showFinal(msg.leaderboard); break;
    case 'host_left':   toast("L'h√¥te a quitt√© la partie"); break;
    case 'error':       document.getElementById('err-msg').textContent=msg.message; break;
  }
}

function showQuestionScreen(msg) {
  showScreen('question-screen');
  currentQuestionType = msg.questionType || 'single';
  document.getElementById('q-body-text').textContent = msg.question;
  document.getElementById('q-progress').textContent  = `Question ${msg.index+1} / ${msg.total}`;

  const imgWrap = document.getElementById('q-player-image');
  const imgEl   = document.getElementById('q-player-img');
  if (msg.image) { imgEl.src=msg.image; imgWrap.style.display='flex'; }
  else           { imgWrap.style.display='none'; }

  const banner = document.getElementById('q-type-banner');
  banner.textContent = currentQuestionType==='multiple' ? 'Choix multiple ‚Äî s√©lectionne puis valide' : 'Choix unique';
  banner.className   = `q-type-banner ${currentQuestionType}`;

  const singleDiv = document.getElementById('a-buttons');
  const multiDiv  = document.getElementById('a-checkboxes');
  const submitBar = document.getElementById('submit-bar');

  // Adapter le nombre de colonnes
  const n = msg.answers.length;
  const cols = n <= 4 ? '1fr 1fr' : n <= 6 ? '1fr 1fr 1fr' : '1fr 1fr 1fr 1fr';
  singleDiv.style.gridTemplateColumns = cols;
  multiDiv.style.gridTemplateColumns  = cols;

  if (currentQuestionType === 'multiple') {
    singleDiv.style.display='none'; multiDiv.style.display='grid'; submitBar.style.display='block';
    document.getElementById('submit-btn').disabled=false;
    renderMultipleButtons(msg.answers);
  } else {
    singleDiv.style.display='grid'; multiDiv.style.display='none'; submitBar.style.display='none';
    renderSingleButtons(msg.answers);
  }

  let t=msg.time;
  const timerEl=document.getElementById('q-timer');
  timerEl.textContent=t; timerEl.classList.remove('urgent');
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    t--; timerEl.textContent=t;
    if (t<=5) timerEl.classList.add('urgent');
    if (t<=0) {
      clearInterval(timerInterval);
      if (!submitted) {
        submitted=true;
        if (currentQuestionType==='multiple') send({type:'answer',pin:gamePin,answer:[...multipleSelection],final:true});
        showAnswered(false,0);
      }
    }
  },1000);
}

function renderSingleButtons(answers) {
  const div=document.getElementById('a-buttons');
  div.innerHTML='';
  answers.forEach((a,i)=>{
    const btn=document.createElement('button');
    btn.className=`a-btn c${i % 12}`;
    btn.innerHTML=`<span class="ico">${getShape(i)}</span><span>${a}</span>`;
    btn.onclick=()=>submitSingle(i);
    div.appendChild(btn);
  });
}

function renderMultipleButtons(answers) {
  const div=document.getElementById('a-checkboxes');
  div.innerHTML='';
  answers.forEach((a,i)=>{
    const btn=document.createElement('div');
    btn.className=`a-check-btn c${i % 12}`;
    btn.id=`check-btn-${i}`;
    btn.innerHTML=`<span class="check-indicator" id="check-ind-${i}">‚òê</span><span class="ico">${getShape(i)}</span><span>${a}</span>`;
    btn.onclick=()=>toggleCheckBtn(i);
    div.appendChild(btn);
  });
}

function toggleCheckBtn(i) {
  if (submitted) return;
  const btn=document.getElementById(`check-btn-${i}`), ind=document.getElementById(`check-ind-${i}`);
  if (multipleSelection.has(i)) { multipleSelection.delete(i); btn.classList.remove('checked'); ind.textContent='‚òê'; }
  else { multipleSelection.add(i); btn.classList.add('checked'); ind.textContent='‚òë'; }
  send({type:'answer',pin:gamePin,answer:[...multipleSelection],final:false});
}

function submitSingle(idx) {
  if (submitted) return; submitted=true;
  document.querySelectorAll('.a-btn').forEach(b=>b.disabled=true);
  send({type:'answer',pin:gamePin,answer:idx,final:true});
  showAnswered(null,0);
}

function submitMultiple() {
  if (submitted) return; submitted=true;
  document.querySelectorAll('.a-check-btn').forEach(b=>b.classList.add('disabled'));
  document.getElementById('submit-btn').disabled=true;
  send({type:'answer',pin:gamePin,answer:[...multipleSelection],final:true});
  showAnswered(null,0);
}

function showAnswered(correct, points) {
  showScreen('answered');
  if (correct===null) {
    document.getElementById('ans-icon').textContent='‚è≥';
    document.getElementById('ans-title').textContent='R√©ponse envoy√©e !';
    document.getElementById('ans-sub').textContent='En attente des r√©sultats...';
    document.getElementById('ans-pts').textContent='';
  } else if (correct) {
    document.getElementById('ans-icon').textContent='‚úÖ';
    document.getElementById('ans-title').textContent='Bonne r√©ponse !';
    document.getElementById('ans-sub').textContent='Tu as gagn√©';
    document.getElementById('ans-pts').textContent=`+${points} pts`;
  } else {
    document.getElementById('ans-icon').textContent=points>0?'üü°':'‚ùå';
    document.getElementById('ans-title').textContent=points>0?'R√©ponse partielle':'Mauvaise r√©ponse...';
    document.getElementById('ans-sub').textContent=points>0?'Points partiels obtenus':'Courage pour la suite !';
    document.getElementById('ans-pts').textContent=points>0?`+${points} pts`:'+0 pts';
  }
}

function showQResult(msg) {
  clearInterval(timerInterval); showScreen('q-result');
  const wasCorrect=lastAnswer.correct===true, wasPartial=!wasCorrect&&lastAnswer.points>0;
  document.getElementById('result-icon').textContent  = wasCorrect?'üéØ':wasPartial?'üü°':'üò¢';
  document.getElementById('result-title').textContent = wasCorrect?'Bonne r√©ponse !':wasPartial?'R√©ponse partielle':'Mauvaise r√©ponse';
  document.getElementById('result-pts').textContent   = (wasCorrect||wasPartial)?`+${lastAnswer.points} pts`:'';
  const me=msg.leaderboard.find(p=>p.name===myName);
  document.getElementById('my-rank').textContent=me?`Classement : #${me.rank} ‚Äî ${me.score} pts`:'';
  const rankEmojis=['ü•á','ü•à','ü•â'];
  document.getElementById('lb-mini').innerHTML=msg.leaderboard.slice(0,5).map((p,i)=>`
    <div class="lb-row ${p.name===myName?'me':''}">
      <span class="lb-rank">${rankEmojis[i]||'#'+p.rank}</span>
      <span class="lb-name">${p.name}${p.name===myName?' üëà':''}</span>
      <span class="lb-score">${p.score} pts</span>
    </div>`).join('');
}

function showFinal(leaderboard) {
  showScreen('final');
  const me=leaderboard.find(p=>p.name===myName), rank=me?me.rank:leaderboard.length;
  document.getElementById('final-rank').textContent={1:'ü•á',2:'ü•à',3:'ü•â'}[rank]||`#${rank}`;
  document.getElementById('final-pts').textContent=`${myScore} points`;
  document.getElementById('full-lb').innerHTML=leaderboard.map((p,i)=>`
    <div class="lb-row ${p.name===myName?'me':''}">
      <span class="lb-rank">${['ü•á','ü•à','ü•â'][i]||'#'+p.rank}</span>
      <span class="lb-name">${p.name}${p.name===myName?' üëà':''}</span>
      <span class="lb-score">${p.score} pts</span>
    </div>`).join('');
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function toast(msg,d=3000) {
  const el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),d);
}
document.getElementById('name-input').addEventListener('keydown', e=>{ if(e.key==='Enter') joinGame(); });
document.getElementById('pin-input').addEventListener('keydown',  e=>{ if(e.key==='Enter') document.getElementById('name-input').focus(); });
</script>
</body>
</html>